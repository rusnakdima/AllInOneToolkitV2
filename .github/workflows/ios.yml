name: Builder for iOS

on:
  push:
    tags:
      - "v*"

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
            args: ""

    runs-on: "macos-latest"
    # runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable corepack
        run: corepack enable

      - name: Setup PNPM
        run: corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust targets for iOS
        run: rustup target add aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim

      - name: Clean caches
        run: |
          pnpm store prune
          cargo clean || true  # Clean target dir if exists

      - name: Initialize Tauri iOS project
        run: pnpm tauri ios init

      - name: Disable code signing in Xcode project
        run: |
          cd src-tauri/gen/apple
          PROJECT_FILE=$(find . -name "project.pbxproj")
          sed -i '' -e 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' \
            -e 's/CODE_SIGN_STYLE = "Automatic";/CODE_SIGN_STYLE = "Manual";/g' \
            -e 's/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "";/g' \
            -e 's/PROVISIONING_PROFILE_SPECIFIER = .*/PROVISIONING_PROFILE_SPECIFIER = "";/g' \
            -e 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' \
            "$PROJECT_FILE"

      - name: Build iOS app without signing
        env:
          CODE_SIGN_IDENTITY: ""
          CODE_SIGNING_REQUIRED: NO
          CODE_SIGNING_ALLOWED: NO
        run: pnpm tauri ios build --export-method development

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: src-tauri/gen/apple/build/arm64/*.ipa
